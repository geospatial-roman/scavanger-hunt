<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scavenger Hunt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #map {
      width: 100vw;
      height: 100vh;
    }
    .hint-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 9999;
      max-width: 90vw;
      padding: 1.2rem 1.4rem 1rem;
      display: none;
    }
    .hint-popup h2 {
      margin: 0 0 .5rem;
      font-size: 1.25rem;
    }
    .hint-popup p {
      margin: 0 0 1rem;
    }
    .hint-popup button {
      border: none;
      background: #2563eb;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-weight: 600;
      cursor: pointer;
    }
    .status-bar {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.55);
      color: #fff;
      padding: .4rem .8rem;
      border-radius: 9999px;
      font-size: .8rem;
      z-index: 5000;
    }
    .show-zone-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 5001;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: .5rem .8rem;
      font-size: .8rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .progress-wrap {
      position: fixed;
      top: 48px;
      left: 50%;
      transform: translateX(-50%);
      width: min(400px, 80vw);
      background: rgba(0,0,0,0.15);
      border-radius: 9999px;
      overflow: hidden;
      height: 10px;
      z-index: 5000;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2563eb, #38bdf8);
      transition: width .3s ease;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="status-bar" id="status">Waiting for locationâ€¦</div>
  <div class="progress-wrap">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <button class="show-zone-btn" onclick="showCurrentZone()">Show next zone</button>

  <!-- Hint modal -->
  <div class="hint-popup" id="hintBox">
    <h2 id="hintTitle">Hint</h2>
    <p id="hintText"></p>
    <button onclick="closeHint()">Got it!</button>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
  <script>
    const LOCATIONS = [
      {
        name: "Start",
        lat: 48.162493646740266,
        lng: 11.553500966165672,
        radius: 40,
        hint: "Welcome! ðŸ¥³ Your first task: go to the big fountain on the square.",
      },
      {
        name: "Fountain",
        lat: 48.162878837180855,
        lng: 11.556791416517495,
        radius: 35,
        hint: "Nice! Now find the red door nearby and stand in front of it.",
      },
      {
        name: "Red Door",
        lat: 48.161733624261046,
        lng: 11.556842230896956,
        radius: 35,
        hint: "Almost there! Last stop: go to the cafÃ© corner.",
      },
      {
        name: "Finish",
        lat: 48.161800809763136,
        lng: 11.554399688680215,
        radius: 30,
        hint: "You made it! ðŸŽ‰ Give this code to the organizer: HUNT-2025",
      },
    ];

    let saved = localStorage.getItem("huntProgress");
    let currentIndex = isNaN(parseInt(saved, 10)) ? 0 : parseInt(saved, 10);

    const map = L.map("map").setView([LOCATIONS[0].lat, LOCATIONS[0].lng], 17);

    // --- Define multiple base maps ---
    const baseLayers = {
      "OpenStreetMap": L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors'
      }),

      "Satellite (ESRI)": L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
        attribution: '&copy; <a href=\"https://www.esri.com/\">Esri</a>, Earthstar Geographics'
      }),

      "Topographic": L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
        attribution: 'Map data: &copy; <a href=\"https://opentopomap.org\">OpenTopoMap</a>'
      }),

      "Dark Mode": L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        attribution: '&copy; <a href="https://carto.com/">CARTO</a>'
      })
    };

    // --- Add your default base layer ---
    baseLayers["OpenStreetMap"].addTo(map);

    // --- Add a control to switch between them ---
    L.control.layers(baseLayers).addTo(map);

    // player marker
    let playerMarker = L.marker([LOCATIONS[0].lat, LOCATIONS[0].lng], { title: "You" }).addTo(map);

    const zoneCircles = new Array(LOCATIONS.length).fill(null);
    createStartZone();
    updateProgress();

    let triedRecovery = false;

    if ("geolocation" in navigator) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const accuracy = pos.coords.accuracy;

          playerMarker.setLatLng([lat, lng]);
          document.getElementById("status").textContent =
            `You are here (accuracy ~${Math.round(accuracy)}m)`;

          if (!map._userMoved) map.setView([lat, lng]);

          if (!triedRecovery) {
            triedRecovery = true;
            tryRecoverProgressFromPosition(lat, lng);
          }

          checkProximity(lat, lng);
        },
        (err) => {
          console.error(err);
          document.getElementById("status").textContent =
            "Couldn't get your location. Make sure GPS is enabled and you're on HTTPS.";
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 8000 }
      );

      map.on("dragstart", () => { map._userMoved = true; });
    } else {
      alert("Geolocation is not supported in this browser.");
    }

    function tryRecoverProgressFromPosition(lat, lng) {
      if (currentIndex > 0) return;

      let lastReachedIndex = -1;
      for (let i = 0; i < LOCATIONS.length; i++) {
        const loc = LOCATIONS[i];
        const dist = distanceInMeters(lat, lng, loc.lat, loc.lng);
        if (dist <= loc.radius) lastReachedIndex = i;
      }

      if (lastReachedIndex >= 0) {
        for (let j = 0; j <= lastReachedIndex; j++) ensureZoneCircle(j, true);
        currentIndex = lastReachedIndex + 1;
        localStorage.setItem("huntProgress", currentIndex.toString());
        showHint(LOCATIONS[lastReachedIndex]);
        updateProgress();
      }
    }

    function createStartZone() {
      const start = LOCATIONS[0];
      const circle = L.circle([start.lat, start.lng], {
        color: "#16a34a",
        fillColor: "#16a34a22",
        fillOpacity: 0.2,
        radius: start.radius
      })
      .addTo(map)
      .bindPopup("<b>Start</b>");
      circle.on("click", () => showHint(start));
      zoneCircles[0] = circle;
    }

    function checkProximity(userLat, userLng) {
      const target = LOCATIONS[currentIndex];
      if (!target) return;

      const dist = distanceInMeters(userLat, userLng, target.lat, target.lng);
      if (dist <= target.radius) {
        ensureZoneCircle(currentIndex, true);
        showHint(target);
        currentIndex++;
        localStorage.setItem("huntProgress", currentIndex.toString());
        updateProgress();
      }
    }

    function ensureZoneCircle(index, visited = false) {
      if (index < 0 || index >= LOCATIONS.length) return;
      const loc = LOCATIONS[index];

      if (zoneCircles[index]) {
        if (visited) {
          zoneCircles[index].setStyle({
            color: "#16a34a",
            fillColor: "#16a34a22",
            fillOpacity: 0.25,
          });
        }
        zoneCircles[index].openPopup();
        return;
      }

      const circle = L.circle([loc.lat, loc.lng], {
        color: visited ? "#16a34a" : "#2563eb",
        fillColor: visited ? "#16a34a22" : "#2563eb33",
        fillOpacity: 0.3,
        radius: loc.radius
      })
      .addTo(map)
      .bindPopup(`<b>${loc.name}</b>`);
      circle.on("click", () => showHint(loc));
      zoneCircles[index] = circle;
      map.setView([loc.lat, loc.lng], 17);
      circle.openPopup();
    }

    function showCurrentZone() {
      const target = LOCATIONS[currentIndex];
      if (!target) {
        document.getElementById("status").textContent = "Hunt complete ðŸŽ‰";
        return;
      }
      ensureZoneCircle(currentIndex, false);
    }

    function distanceInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const Ï†1 = lat1 * Math.PI/180;
      const Ï†2 = lat2 * Math.PI/180;
      const Î”Ï† = (lat2-lat1) * Math.PI/180;
      const Î”Î» = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function showHint(locationObj) {
      const box = document.getElementById("hintBox");
      document.getElementById("hintTitle").textContent = `Next stop: ${locationObj.name}`;
      document.getElementById("hintText").textContent = locationObj.hint;
      box.style.display = "block";
      document.getElementById("status").textContent = `Unlocked: ${locationObj.name}`;
    }

    function closeHint() {
      const box = document.getElementById("hintBox");
      box.style.display = "none";
      if (currentIndex >= LOCATIONS.length) {
        document.getElementById("status").textContent = "Hunt complete ðŸŽ‰";
      } else {
        document.getElementById("status").textContent =
          `Go to: ${LOCATIONS[currentIndex].name}`;
      }
    }

    function updateProgress() {
      const bar = document.getElementById("progressBar");
      const total = LOCATIONS.length;
      const completed = Math.min(currentIndex, total);
      bar.style.width = (completed / total) * 100 + "%";
    }

    window.showCurrentZone = showCurrentZone;
    window.closeHint = closeHint;
  </script>
</body>
</html>
